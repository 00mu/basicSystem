(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{308:function(t,s,n){"use strict";n.r(s);var a=n(29),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"_05-javascript-运行机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_05-javascript-运行机制"}},[t._v("#")]),t._v(" 05 JavaScript 运行机制")]),t._v(" "),n("p",[t._v("建议阅读原文 "),n("a",{attrs:{href:"https://juejin.im/post/5d5b4c2df265da03dd3d73e5",target:"_blank",rel:"noopener noreferrer"}},[t._v("从多线程到 Event Loop 全面梳理"),n("OutboundLink")],1),t._v("，感谢原作者。")]),t._v(" "),n("p",[t._v("定义：JavaScript 是一门 "),n("strong",[t._v("单线程")]),t._v(" 语言，通过 "),n("strong",[t._v("事件队列")]),t._v("（Event Loop）的方式实现异步回调。")]),t._v(" "),n("p",[t._v("根据关键字，试试能不能揭开这层面纱。")]),t._v(" "),n("h2",{attrs:{id:"进程-与-线程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#进程-与-线程"}},[t._v("#")]),t._v(" 进程 与 线程")]),t._v(" "),n("p",[t._v("进程是资源分配的最小单位，线程是 CPU 调度的最小单位。")]),t._v(" "),n("p",[t._v("从核心 CPU 开始说起，CPU 不断地自动取指令、翻译指令、然后执行指令，内存用来执行存取 IO 操作又非常耗时，CPU 不会傻等着做个标记跳转去执行下一个的程序指令，再执行下个程序的执行，空闲了就回头来继续执行前面的程序指令，如此往复。")]),t._v(" "),n("p",[t._v("线程简单为来 CPU 一个回切换的单个任务，任意时刻 CPU 仅运行一个进程，宏观上看进程们总是一致向前，微观看是交替前行。多核在同一时刻可以运行多个任务。（进站检票口，一个检票口两列队伍）")]),t._v(" "),n("p",[t._v("一个进程内可以有多个线程，多线程可以同时协同工作。（进程比做一条流水线，线程流水线上的工人），进程与进程之间通信比较难，线程之间是共享资源通信方便。")]),t._v(" "),n("p",[t._v("一个应用程序是一个进程，一个进程分为多个子进程来实现多个功能，这个程序就是多进程的。")]),t._v(" "),n("h4",{attrs:{id:"浏览器是多进程的"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器是多进程的"}},[t._v("#")]),t._v(" 浏览器是多进程的")]),t._v(" "),n("p",[t._v("浏览器之所以能运行是因为系统给它分配了资源（CPU 和内存）。多进程可以充分利用 CPU 多核优势，避免单页面或者第三方插件 crash 影响整个浏览器。")]),t._v(" "),n("ul",[n("li",[t._v("主进程\n"),n("ul",[n("li",[t._v("协调控制其他进程")]),t._v(" "),n("li",[t._v("浏览器界面显示，用户交互、前进、后退、收藏")]),t._v(" "),n("li",[t._v("将渲染进程得到的内存中的 Bitmap，绘制到用户界面上")]),t._v(" "),n("li",[t._v("处理不可见操作，网络请求，文件访问等")])])]),t._v(" "),n("li",[t._v("第三方插件进程")]),t._v(" "),n("li",[t._v("GPU 进程\n"),n("ul",[n("li",[t._v("最多一个，用于 3D 绘制")])])]),t._v(" "),n("li",[n("code",[t._v("渲染进程")]),t._v("（Renderer 进程），就是我们说的 "),n("code",[t._v("浏览器内核")]),t._v(" "),n("ul",[n("li",[t._v("负责页面渲染、脚本执行、事件处理等")]),t._v(" "),n("li",[t._v("默认每一个 tab 页一个渲染进程，互不影响（过多标签页浏览器可能存在优化合并进程）")])])])]),t._v(" "),n("h4",{attrs:{id:"浏览器内核（渲染进程）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器内核（渲染进程）"}},[t._v("#")]),t._v(" 浏览器内核（渲染进程）")]),t._v(" "),n("p",[t._v("渲染进程包含多个线程：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("GUI 渲染线程")]),t._v(" "),n("ul",[n("li",[t._v("负责渲染页面，布局和绘制")]),t._v(" "),n("li",[t._v("页面需要重绘和回流时，该线程就会执行")]),t._v(" "),n("li",[t._v("与 JS 引擎线程互斥，防止渲染结果不可预期")])])]),t._v(" "),n("li",[n("p",[t._v("JS 引擎线程")]),t._v(" "),n("ul",[n("li",[t._v("处理解析 JavaScript 脚本（chrome 中 V8 引擎）")]),t._v(" "),n("li",[t._v("只有一个 JS 引擎线程（单线程），等待任务队列中的任务到来，然后处理")]),t._v(" "),n("li",[t._v("与 GUI 线程互斥")])])]),t._v(" "),n("li",[n("p",[t._v("事件触发线程")]),t._v(" "),n("ul",[n("li",[t._v("用来控制事件循环（鼠标点击、Ajax 等异步任务）管理任务队列，协助 JS 引擎线程")]),t._v(" "),n("li",[t._v("当事件满足触发条件时，将事件放入"),n("strong",[t._v("JS 引擎线所在的执行队列")]),t._v("中")])])]),t._v(" "),n("li",[n("p",[t._v("定时器触发线程")]),t._v(" "),n("ul",[n("li",[t._v("setInterval 与 setTimeout 所在的线程")]),t._v(" "),n("li",[t._v("定时任务并不是由 js 引擎计时，是由定时触发线程来计时的")]),t._v(" "),n("li",[t._v("计时完毕后，通知事件触发线程存入任务队列")]),t._v(" "),n("li",[t._v("setTimeout 中低于 4ms 的时间间隔算为 4ms")])])]),t._v(" "),n("li",[n("p",[t._v("异步 http 请求线程")]),t._v(" "),n("ul",[n("li",[t._v("单独的一个线程用来处理 Ajax 请求")]),t._v(" "),n("li",[t._v("请求完成后若有回调函数，通知事件触发线程")])])])]),t._v(" "),n("p",[t._v("至此，我们可以回答两个问题：")]),t._v(" "),n("h5",{attrs:{id:"_1-为什么-js-是单线程的？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么-js-是单线程的？"}},[t._v("#")]),t._v(" 1. 为什么 JS 是单线程的？")]),t._v(" "),n("p",[t._v("一方面历史原因，JS 创建之初当时多进程架构不流行；另外多线程比较复杂，多线程需要枷锁，编码的复杂性回增高。")]),t._v(" "),n("p",[t._v("而且，在多线程不加锁的情况下，如果多线程同时操作 DOM，最终会导致渲染结果不可期。")]),t._v(" "),n("h5",{attrs:{id:"_2-为什么-gui-渲染线程与-js-引擎线程互斥？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-为什么-gui-渲染线程与-js-引擎线程互斥？"}},[t._v("#")]),t._v(" 2. 为什么 GUI 渲染线程与 JS 引擎线程互斥？")]),t._v(" "),n("p",[t._v("这是由于 JS 可以操作 DOM，如果 JS 线程和 UI 线程同时运行，那可能存在修改元素的同时又在渲染元素出现不可期的结果。")]),t._v(" "),n("p",[t._v("因此，为了防止渲染出现不可预期的结果，浏览器设定 GUI 渲染线程和 JS 引擎线程为互斥关系， 当 JS 引擎线程执行时 GUI 渲染线程会被挂起，GUI 更新则会被保存在一个队列中等待 JS 引擎线程空闲时立即被执行。")]),t._v(" "),n("h5",{attrs:{id:"_3-webworker，是-js-的多线程吗？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-webworker，是-js-的多线程吗？"}},[t._v("#")]),t._v(" 3. WebWorker，是 JS 的多线程吗？")]),t._v(" "),n("p",[t._v("答案是否定的，JS 是单线程本质不会变。如果 JS 执行时间过长阻塞页面，怎么办？HTML5 新增了"),n("code",[t._v("Web Worker")]),t._v("作为 JS 的外挂。")]),t._v(" "),n("blockquote",[n("p",[t._v("定义：Web Worker 为 Web 内容在后台线程中运行脚本提供了一种简单的方法。线程可以执行任务而不干扰用户界面。一个 worker 是使用一个构造函数创建的一个对象(e.g. Worker()) 运行一个命名的 JavaScript 文件 。这个文件包含将在工作线程中运行的代码; workers 运行在另一个全局上下文中,不同于当前的 window。因此，使用 window 快捷方式获取当前全局的范围 (而不是 self) 在一个 Worker 内将返回错误")])]),t._v(" "),n("ol",[n("li",[t._v("创建 Worker 时，JS 引擎向浏览器申请开一个子线程（子线程是浏览器开的，完全受主线程控制，而且不能操作 DOM）")]),t._v(" "),n("li",[t._v("JS 引擎线程与 worker 线程间通过特定的方式通信（postMessage API，需要通过序列化对象来与线程交互特定的数据）")])]),t._v(" "),n("p",[t._v("如果有非常耗时的工作，单独开一个 Worker 线程，和 JS 引擎线程互不影响，只待计算出结果通知给 JS 线程即可。")]),t._v(" "),n("h3",{attrs:{id:"js-的运行机制-event-loop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#js-的运行机制-event-loop"}},[t._v("#")]),t._v(" JS 的运行机制 "),n("code",[t._v("Event Loop")])]),t._v(" "),n("p",[t._v("我们已经了解到 JS 是单线程的，如果没有异步任务，往往会因为一段执行时间比较长的代码，导致后面代码无法执行，页面卡死。")]),t._v(" "),n("p",[t._v("同步任务是说一个任务从头到尾可以依次执行完；异步任务，不能连续执行，先执行一段然后执行其他代码，然后在回来执行另一段。")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("执行栈")]),t._v(" "),n("th",[t._v("任务队列")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("JS 引擎线程")]),t._v(" "),n("td",[t._v("事件触发线程")])])])]),t._v(" "),n("ol",[n("li",[t._v("JS 引擎线程上管理一个"),n("code",[t._v("执行栈")]),t._v("，同步任务都先扔到这个栈里。")]),t._v(" "),n("li",[t._v("事件触发线程上管理一个"),n("code",[t._v("任务队列")]),t._v("，当异步任务触发条件达成，各自线程将回调事件放到"),n("code",[t._v("任务队列")]),t._v("中。")]),t._v(" "),n("li",[t._v("当"),n("code",[t._v("执行栈")]),t._v("中所有同步任务执行完毕，"),n("code",[t._v("任务队列")]),t._v("中如果有事件则扔给"),n("code",[t._v("执行栈")]),t._v("，JS 引擎立即开始执行。")]),t._v(" "),n("li",[t._v("如此循环。")])]),t._v(" "),n("h4",{attrs:{id:"我们来看看都有哪些异步任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#我们来看看都有哪些异步任务"}},[t._v("#")]),t._v(" 我们来看看都有哪些异步任务")]),t._v(" "),n("ol",[n("li",[t._v("原生事件")])]),t._v(" "),n("p",[t._v("onclick、onmouseover、onmouseout、onmousedown、onmouseup\n、ondblclick、onkeydown、onkeypress、onkeyup 等，窗口 onresize ，滚动条 onscroll 等，资源加载 onload 等")]),t._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[t._v("定时器")])]),t._v(" "),n("p",[t._v("当代码执行到 setTimeout/setInterval，"),n("code",[t._v("JS引擎线程")]),t._v("通知"),n("code",[t._v("定时触发器线程")]),t._v("接管回调函数，到达指定的时间长度后将回调事件立即放到"),n("code",[t._v("任务队列")]),t._v("。")]),t._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[t._v("http")])]),t._v(" "),n("p",[t._v("当代码执行到 XHR/fetch，"),n("code",[t._v("JS引擎线程")]),t._v("通知"),n("code",[t._v("异步http请求线程")]),t._v("发送一个网络请求，请求成功后将回调事件立即放到"),n("code",[t._v("任务队列")]),t._v("。")]),t._v(" "),n("ol",{attrs:{start:"4"}},[n("li",[t._v("Promise")])]),t._v(" "),n("p",[t._v("promise 本身是同步任务，then 后面的是异步")]),t._v(" "),n("ol",{attrs:{start:"5"}},[n("li",[t._v("async")])]),t._v(" "),n("h4",{attrs:{id:"事件循环中的-宏任务和微任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件循环中的-宏任务和微任务"}},[t._v("#")]),t._v(" 事件循环中的 宏任务和微任务")]),t._v(" "),n("p",[t._v("宏任务，每次执行栈执行从头到尾执行完毕叫一个宏任务。任务队列中的每一个事件都是一个宏任务。")]),t._v(" "),n("p",[t._v("微任务，当前阶段宏任务执行完毕后立即执行的任务。(ES6 中的 Promise.then)")]),t._v(" "),n("ul",[n("li",[t._v("macro-task(宏任务)：包括整体代码 script，setTimeout，setInterval")]),t._v(" "),n("li",[t._v("micro-task(微任务)：Promise.then，MutationObsever,process.nextTick(nodejs)")])]),t._v(" "),n("ol",[n("li",[t._v("执行宏任务，执行栈中没有就从事件队列中取（第一轮宏任务从"),n("code",[t._v("<script>")]),t._v("开始）")]),t._v(" "),n("li",[t._v("执行过程中如果遇到微任务，就将它添加到微任务的任务队列中")]),t._v(" "),n("li",[t._v("宏任务执行完毕后，立即执行当前微任务队列中的所有微任务（依次执行）")]),t._v(" "),n("li",[t._v("所有微任务执行完毕，从执行队列中读取开始下一轮宏任务")])]),t._v(" "),n("img",{attrs:{src:t.$withBase("/eventloop1.png"),alt:"eventloop1"}}),t._v(" "),n("div",{staticClass:"language-JS extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'4'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'5'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nprocess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'6'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'7'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'9'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'10'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'11'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'12'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第 1 轮事件循环")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 宏任务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 7")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 微任务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 6")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 8")]),t._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第 2 轮事件循环")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 宏任务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 微任务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 5")]),t._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第 3 轮事件循环")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 宏任务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 9")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 11")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 微任务")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 10")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 12")]),t._v("\n")])])]),n("p",[t._v("注意，new Promise 直接执行，then 被分发到微任务队列")]),t._v(" "),n("h3",{attrs:{id:"宏任务-与-渲染"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#宏任务-与-渲染"}},[t._v("#")]),t._v(" 宏任务 与 渲染")]),t._v(" "),n("p",[t._v("前面说到，"),n("code",[t._v("JS引擎")]),t._v(" 和 "),n("code",[t._v("GUI引擎")]),t._v("互斥关系，为了能使二者交替有序进行，会在一个 "),n("code",[t._v("宏任务")]),t._v(" 执行结束后，在一下个 "),n("code",[t._v("宏任务")]),t._v(" 执行前，"),n("code",[t._v("GUI渲染线程")]),t._v(" 介入对页面进行渲染。渲染完毕，"),n("code",[t._v("JS线程")]),t._v(" 继续接管，开始下一个 "),n("code",[t._v("宏任务")]),t._v("（从事件队列中获取）。")]),t._v(" "),n("img",{attrs:{src:t.$withBase("/eventloop2.png"),alt:"eventloop2"}}),t._v(" "),n("p",[t._v("这里也连带出一个知识点，Vue.nextTick")])])}),[],!1,null,null,null);s.default=e.exports}}]);